name: Build & Release

on:
  push:
    branches:
      - main

permissions:
  contents: write   # Needed to create tags & releases

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Set up Go
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'

      # 3️⃣ Build the binary
      - name: Build
        run: go build -o app cmd/main.go

      # 4️⃣ Read version from file
      - name: Get version
        id: get_version
        run: echo "VERSION=$(cat version)" >> $GITHUB_ENV

      # 5️⃣ Create a tag if it does not exist
      - name: Create tag
        run: |
          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "Tag v${VERSION} already exists. Skipping tag creation."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "v${VERSION}"
            git push origin "v${VERSION}"
          fi

      # 6️⃣ Create GitHub Release and upload binary
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          files: app
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

